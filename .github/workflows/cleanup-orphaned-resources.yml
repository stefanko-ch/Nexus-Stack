name: Cleanup Orphaned Resources

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  cleanup:
    name: Cleanup Orphaned Cloudflare Resources
    runs-on: ubuntu-latest
    env:
      TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      TF_VAR_cloudflare_account_id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      TF_VAR_cloudflare_zone_id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
      TF_VAR_domain: ${{ secrets.DOMAIN }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Cleanup KV Namespace
        run: |
          echo "üîç Finding KV Namespace..."
          # Resource prefix is derived from domain (e.g., stefanko.ch -> nexus-stefanko-ch)
          DOMAIN="${{ secrets.DOMAIN }}"
          RESOURCE_PREFIX="nexus-${DOMAIN//./-}"
          KV_NAMESPACE_TITLE="${RESOURCE_PREFIX}-kv"
          
          # Get all KV namespaces
          KV_NAMESPACES_RESPONSE=$(curl -s \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/storage/kv/namespaces" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json")
          
          KV_NAMESPACE_ID=$(echo "$KV_NAMESPACES_RESPONSE" | jq -r ".result[] | select(.title == \"$KV_NAMESPACE_TITLE\") | .id" 2>/dev/null || echo "")
          
          if [ -n "$KV_NAMESPACE_ID" ] && [ "$KV_NAMESPACE_ID" != "null" ]; then
            echo "  Found KV Namespace ID: $KV_NAMESPACE_ID"
            
            # Delete all keys first
            echo "  Deleting keys in namespace..."
            KEYS_RESPONSE=$(curl -s \
              "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/storage/kv/namespaces/$KV_NAMESPACE_ID/keys" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json")
            
            KEYS=$(echo "$KEYS_RESPONSE" | jq -r '.result[].name' 2>/dev/null || echo "")
            
            if [ -n "$KEYS" ]; then
              for key in $KEYS; do
                curl -s -X DELETE \
                  "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/storage/kv/namespaces/$KV_NAMESPACE_ID/values/$key" \
                  -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" >/dev/null 2>&1 || true
              done
              echo "  ‚úì Keys deleted"
            fi
            
            # Delete the namespace
            KV_DELETE_RESPONSE=$(curl -s -X DELETE \
              "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/storage/kv/namespaces/$KV_NAMESPACE_ID" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json")
            
            if echo "$KV_DELETE_RESPONSE" | grep -q '"success":true'; then
              echo "‚úÖ KV Namespace deleted"
            else
              echo "‚ö†Ô∏è  Could not delete KV Namespace"
              echo "$KV_DELETE_RESPONSE" | jq '.' 2>/dev/null || echo "$KV_DELETE_RESPONSE"
            fi
          else
            echo "‚ö†Ô∏è  KV Namespace not found (may already be deleted)"
          fi

      - name: Cleanup Access Application
        run: |
          echo "üîç Finding Access Application..."
          ACCESS_APP_DOMAIN="control.${{ secrets.DOMAIN }}"
          
          # Get all Access applications for the zone
          ACCESS_APPS_RESPONSE=$(curl -s \
            "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/access/apps" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json")
          
          ACCESS_APP_ID=$(echo "$ACCESS_APPS_RESPONSE" | jq -r ".result[] | select(.domain == \"$ACCESS_APP_DOMAIN\") | .id" 2>/dev/null || echo "")
          
          if [ -n "$ACCESS_APP_ID" ] && [ "$ACCESS_APP_ID" != "null" ]; then
            echo "  Found Access Application ID: $ACCESS_APP_ID"
            
            # Delete the Access Application
            ACCESS_DELETE_RESPONSE=$(curl -s -X DELETE \
              "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/access/apps/$ACCESS_APP_ID" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json")
            
            if echo "$ACCESS_DELETE_RESPONSE" | grep -q '"success":true'; then
              echo "‚úÖ Access Application deleted"
            else
              echo "‚ö†Ô∏è  Could not delete Access Application"
              echo "$ACCESS_DELETE_RESPONSE" | jq '.' 2>/dev/null || echo "$ACCESS_DELETE_RESPONSE"
            fi
          else
            echo "‚ö†Ô∏è  Access Application not found (may already be deleted)"
          fi

      - name: Summary
        run: |
          echo ""
          echo "‚úÖ Cleanup complete!"
          echo ""
          echo "You can now run 'make up' or deploy via GitHub Actions again."
