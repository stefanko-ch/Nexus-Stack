name: Initial Setup

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: write

concurrency:
  group: infrastructure
  cancel-in-progress: false

jobs:
  setup-control-plane:
    name: Setup Control Plane
    uses: ./.github/workflows/setup-control-plane.yaml
    secrets: inherit

  spin-up:
    name: Spin Up Nexus-Stack
    needs: setup-control-plane
    uses: ./.github/workflows/spin-up.yml
    with:
      # Pass R2 credentials from setup-control-plane to spin-up
      # This enables fully automated initial deployment without pre-existing secrets
      r2_access_key_id: ${{ needs.setup-control-plane.outputs.r2_access_key_id }}
      r2_secret_access_key: ${{ needs.setup-control-plane.outputs.r2_secret_access_key }}
      # Pass SSH public key (private key is saved as secret by setup-control-plane)
      ssh_public_key: ${{ needs.setup-control-plane.outputs.ssh_public_key }}
    secrets: inherit
